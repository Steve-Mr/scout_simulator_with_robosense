'use strict';

const util = require('util');
const pngjs = require('pngjs');
const stream = require('stream');

module.exports = util.promisify(pngToPgm);

function pngToPgm(buffer, cb) {
    let imageStream = new stream.PassThrough();
    imageStream.end(buffer);

    imageStream.pipe(new pngjs.PNG()).on('parsed', function () {
        let pgmArray = createPGMArray(this.data, this.width, this.height);
        let pgmBuffer = arrayToPGMBuffer(pgmArray);
        cb(null, pgmBuffer);
    });
}

function createPGMArray(data, width, height) {
    let pgmData = [];

    for (var y = 0; y < height; y++) {
        pgmData.push(Array(width));

        for (var x = 0; x < width; x++) {
            var idx = (width * y + x) << 2;

            let red = data[idx];
            let blue = data[idx + 1];
            let green = data[idx + 2];
            let alpha = data[idx + 3];

            if (alpha === 0) {
                pgmData[y][x] = 205;
            } else {
                pgmData[y][x]  = Math.floor((red + blue + green)/3);
            }
        }
    }

    return pgmData;
}

function arrayToPGMBuffer(pgmArray) {
    let pgmString = `P5\n${pgmArray[0].length} ${pgmArray.length}\n255\n`;
    let pgmBuffer = Buffer.from(pgmString);
    
    for (let row of pgmArray) {
        let typedArray = new Uint8Array(row);
        pgmBuffer = Buffer.concat([pgmBuffer, typedArray]);
    }
    return pgmBuffer;
}
